<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="添加自己得docker加速镜像" /><meta name="author" content="小神仙" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="上一篇博文讲到了docker如何添加加速镜像，但是加速镜像地址是用的别人的，这里我们来注册自己的加速镜像地址" /><meta property="og:description" content="上一篇博文讲到了docker如何添加加速镜像，但是加速镜像地址是用的别人的，这里我们来注册自己的加速镜像地址" /><link rel="canonical" href="https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F" /><meta property="og:url" content="https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F" /><meta property="og:site_name" content="dashenxian" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-11-16T00:14:08+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="添加自己得docker加速镜像" /> <script type="application/ld+json"> {"datePublished":"2024-11-16T00:14:08+08:00","description":"上一篇博文讲到了docker如何添加加速镜像，但是加速镜像地址是用的别人的，这里我们来注册自己的加速镜像地址","dateModified":"2024-11-16T00:14:08+08:00","headline":"添加自己得docker加速镜像","mainEntityOfPage":{"@type":"WebPage","@id":"https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://dashenxian.github.io/assets/img/logo.png"},"name":"小神仙"},"url":"https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F","author":{"@type":"Person","name":"小神仙"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>添加自己得docker加速镜像 - dashenxian</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="dashenxian"><meta name="application-name" content="dashenxian"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="topbar-wrapper" class="row topbar-down"><div id="topbar" class="col-12 d-flex h-100 align-items-center"><div id="topbar-logoside" class="col"> <a id="topbar-logo" href="https://dashenxian.github.io" alt="avatar"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <a id="topbar-title" class="site-title" href="https://dashenxian.github.io" alt="dashenxian"> dashenxian </a></div><div id="topbar-searchside" class="justify-content-center col-5"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div><div class="col"></div></div></div><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="sidebar-box post-item-box profile-wrapper text-center"><div id="avatar"> <a href="" alt="avatar" class="mx-auto"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">小神仙</a></div><div class="site-subtitle font-italic">.NET and Windows App Developer</div></div><ul class="sidebar-box post-item-box"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/friends/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>朋友和收藏</span> </a><li class="nav-item"> <a href="/mind/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>胡思乱想</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/dashenxian" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['125880321','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>添加自己得docker加速镜像</h1><div class="post-meta text-muted"><div class="d-flex"> <span> 小神仙 </span> <span> 发表于 <em class="timeago" date="2024-11-16 00:26:00 +0800" data-toggle="tooltip" data-placement="bottom" title="2024-11-16, 00:26 +0800" >11-16</em> </span> <span> 更新于 <em class="timeago" date="2024-11-16 00:14:08 +0800" data-toggle="tooltip" data-placement="bottom" title="2024-11-16, 00:14 +0800" >11-16</em> </span></div></div><div class="post-content"><p>上一篇<a href="https://dashenxian.github.io/post/snap-%E5%AE%89%E8%A3%85%E7%9A%84docker-%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F%E5%92%8C%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1">博文</a>讲到了docker如何添加加速镜像，但是加速镜像地址是用的别人的，这里我们来注册自己的加速镜像地址</p><hr /><div id="toc"></div><h2 id="注册账号">注册账号<a href="#注册账号"><i class="fas fa-hashtag"></i></a></h2></h2><p>注册<a href="https://dash.cloudflare.com">cloudflare</a>账号</p><h2 id="部署脚本">部署脚本<a href="#部署脚本"><i class="fas fa-hashtag"></i></a></h2></h2><p>左侧菜单中 <code class="language-plaintext highlighter-rouge">Workers 和 Pages</code> –&gt; <code class="language-plaintext highlighter-rouge">概述</code> –&gt; <code class="language-plaintext highlighter-rouge">创建</code></p><ol><li><p>创建worker <img data-proofer-ignore data-src="../static/posts/2024/2024-11-16-添加自己得docker加速镜像01.png" alt="创建worker" /></p><li><p>修改名称，也可用默认的名称，点击部署 <img data-proofer-ignore data-src="../static/posts/2024/2024-11-16-添加自己得docker加速镜像02.png" alt="修改名称" /></p><li><p>点<code class="language-plaintext highlighter-rouge">编辑代码</code> <img data-proofer-ignore data-src="../static/posts/2024/2024-11-16-添加自己得docker加速镜像03.png" alt="修改名称" /></p><li><p>复制以下代码到worker.js编辑窗口中,注意1中的域名可以直接填写2处的域名，也可以是你自己的域名，你自己的域名必须是通过cloudflare解析的 <img data-proofer-ignore data-src="../static/posts/2024/2024-11-16-添加自己得docker加速镜像04.png" alt="编辑代码" /></p></ol><div class="language-js highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
</pre><td class="rouge-code"><pre><span class="c1">// _worker.js</span>

<span class="c1">// Docker镜像仓库主机地址</span>
<span class="kd">let</span> <span class="nx">hub_host</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">registry-1.docker.io</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// Docker认证服务器地址</span>
<span class="kd">const</span> <span class="nx">auth_url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://auth.docker.io</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// 自定义的工作服务器地址</span>
<span class="kd">let</span> <span class="nx">workers_url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://xxx/</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">屏蔽爬虫UA</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">netcraft</span><span class="dl">'</span><span class="p">];</span>

<span class="c1">// 根据主机名选择对应的上游地址</span>
<span class="kd">function</span> <span class="nx">routeByHosts</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 定义路由表</span>
	<span class="kd">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="p">{</span>
		<span class="c1">// 生产环境</span>
		<span class="dl">"</span><span class="s2">quay</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">quay.io</span><span class="dl">"</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">gcr</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">gcr.io</span><span class="dl">"</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">k8s-gcr</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">k8s.gcr.io</span><span class="dl">"</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">k8s</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">registry.k8s.io</span><span class="dl">"</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">ghcr</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ghcr.io</span><span class="dl">"</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">cloudsmith</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">docker.cloudsmith.io</span><span class="dl">"</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">nvcr</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nvcr.io</span><span class="dl">"</span><span class="p">,</span>

		<span class="c1">// 测试环境</span>
		<span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">registry-1.docker.io</span><span class="dl">"</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="nx">host</span> <span class="k">in</span> <span class="nx">routes</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span> <span class="nx">routes</span><span class="p">[</span><span class="nx">host</span><span class="p">],</span> <span class="kc">false</span> <span class="p">];</span>
	<span class="k">else</span> <span class="k">return</span> <span class="p">[</span> <span class="nx">hub_host</span><span class="p">,</span> <span class="kc">true</span> <span class="p">];</span>
<span class="p">}</span>

<span class="cm">/** @type {RequestInit} */</span>
<span class="kd">const</span> <span class="nx">PREFLIGHT_INIT</span> <span class="o">=</span> <span class="p">{</span>
	<span class="c1">// 预检请求配置</span>
	<span class="na">headers</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">({</span>
		<span class="dl">'</span><span class="s1">access-control-allow-origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// 允许所有来源</span>
		<span class="dl">'</span><span class="s1">access-control-allow-methods</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// 允许的HTTP方法</span>
		<span class="dl">'</span><span class="s1">access-control-max-age</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1728000</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// 预检请求的缓存时间</span>
	<span class="p">}),</span>
<span class="p">}</span>

<span class="cm">/**
 * 构造响应
 * @param {any} body 响应体
 * @param {number} status 响应状态码
 * @param {Object&lt;string, string&gt;} headers 响应头
 */</span>
<span class="kd">function</span> <span class="nx">makeRes</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">status</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
	<span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">access-control-allow-origin</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span> <span class="c1">// 允许所有来源</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">})</span> <span class="c1">// 返回新构造的响应</span>
<span class="p">}</span>

<span class="cm">/**
 * 构造新的URL对象
 * @param {string} urlStr URL字符串
 */</span>
<span class="kd">function</span> <span class="nx">newUrl</span><span class="p">(</span><span class="nx">urlStr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">try</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">urlStr</span><span class="p">)</span> <span class="c1">// 尝试构造新的URL对象</span>
	<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">null</span> <span class="c1">// 构造失败返回null</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isUUID</span><span class="p">(</span><span class="nx">uuid</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 定义一个正则表达式来匹配 UUID 格式</span>
	<span class="kd">const</span> <span class="nx">uuidRegex</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">[</span><span class="sr">0-9a-f</span><span class="se">]{8}</span><span class="sr">-</span><span class="se">[</span><span class="sr">0-9a-f</span><span class="se">]{4}</span><span class="sr">-</span><span class="se">[</span><span class="sr">4</span><span class="se">][</span><span class="sr">0-9a-f</span><span class="se">]{3}</span><span class="sr">-</span><span class="se">[</span><span class="sr">89ab</span><span class="se">][</span><span class="sr">0-9a-f</span><span class="se">]{3}</span><span class="sr">-</span><span class="se">[</span><span class="sr">0-9a-f</span><span class="se">]{12}</span><span class="sr">$/i</span><span class="p">;</span>

	<span class="c1">// 使用正则表达式测试 UUID 字符串</span>
	<span class="k">return</span> <span class="nx">uuidRegex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">uuid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">nginx</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">`
	&lt;!DOCTYPE html&gt;
	&lt;html&gt;
	&lt;head&gt;
	&lt;title&gt;Welcome to nginx!&lt;/title&gt;
	&lt;style&gt;
		body {
			width: 35em;
			margin: 0 auto;
			font-family: Tahoma, Verdana, Arial, sans-serif;
		}
	&lt;/style&gt;
	&lt;/head&gt;
	&lt;body&gt;
	&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
	&lt;p&gt;If you see this page, the nginx web server is successfully installed and
	working. Further configuration is required.&lt;/p&gt;

	&lt;p&gt;For online documentation and support please refer to
	&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
	Commercial support is available at
	&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

	&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
	&lt;/body&gt;
	&lt;/html&gt;
	`</span>
	<span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">searchInterface</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">`
	&lt;!DOCTYPE html&gt;
	&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt;Docker Hub Search&lt;/title&gt;
		&lt;style&gt;
		body {
			font-family: Arial, sans-serif;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100vh;
			margin: 0;
			background: linear-gradient(to right, rgb(28, 143, 237), rgb(29, 99, 237));
		}
		.logo {
			margin-bottom: 20px;
		}
		.search-container {
			display: flex;
			align-items: center;
		}
		#search-input {
			padding: 10px;
			font-size: 16px;
			border: 1px solid #ddd;
			border-radius: 4px;
			width: 300px;
			margin-right: 10px;
		}
		#search-button {
			padding: 10px;
			background-color: rgba(255, 255, 255, 0.2); /* 设置白色，透明度为10% */
			border: none;
			border-radius: 4px;
			cursor: pointer;
			width: 44px;
			height: 44px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		#search-button svg {
			width: 24px;
			height: 24px;
		}
		&lt;/style&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;div class="logo"&gt;
		&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 18" fill="#ffffff" width="100" height="75"&gt;
			&lt;path d="M23.763 6.886c-.065-.053-.673-.512-1.954-.512-.32 0-.659.03-1.01.087-.248-1.703-1.651-2.533-1.716-2.57l-.345-.2-.227.328a4.596 4.596 0 0 0-.611 1.433c-.23.972-.09 1.884.403 2.666-.596.331-1.546.418-1.744.42H.752a.753.753 0 0 0-.75.749c-.007 1.456.233 2.864.692 4.07.545 1.43 1.355 2.483 2.409 3.13 1.181.725 3.104 1.14 5.276 1.14 1.016 0 2.03-.092 2.93-.266 1.417-.273 2.705-.742 3.826-1.391a10.497 10.497 0 0 0 2.61-2.14c1.252-1.42 1.998-3.005 2.553-4.408.075.003.148.005.221.005 1.371 0 2.215-.55 2.68-1.01.505-.5.685-.998.704-1.053L24 7.076l-.237-.19Z"&gt;&lt;/path&gt;
			&lt;path d="M2.216 8.075h2.119a.186.186 0 0 0 .185-.186V6a.186.186 0 0 0-.185-.186H2.216A.186.186 0 0 0 2.031 6v1.89c0 .103.083.186.185.186Zm2.92 0h2.118a.185.185 0 0 0 .185-.186V6a.185.185 0 0 0-.185-.186H5.136A.185.185 0 0 0 4.95 6v1.89c0 .103.083.186.186.186Zm2.964 0h2.118a.186.186 0 0 0 .185-.186V6a.186.186 0 0 0-.185-.186H8.1A.185.185 0 0 0 7.914 6v1.89c0 .103.083.186.186.186Zm2.928 0h2.119a.185.185 0 0 0 .185-.186V6a.185.185 0 0 0-.185-.186h-2.119a.186.186 0 0 0-.185.186v1.89c0 .103.083.186.185.186Zm-5.892-2.72h2.118a.185.185 0 0 0 .185-.186V3.28a.186.186 0 0 0-.185-.186H5.136a.186.186 0 0 0-.186.186v1.89c0 .103.083.186.186.186Zm2.964 0h2.118a.186.186 0 0 0 .185-.186V3.28a.186.186 0 0 0-.185-.186H8.1a.186.186 0 0 0-.186.186v1.89c0 .103.083.186.186.186Zm2.928 0h2.119a.185.185 0 0 0 .185-.186V3.28a.186.186 0 0 0-.185-.186h-2.119a.186.186 0 0 0-.185.186v1.89c0 .103.083.186.185.186Zm0-2.72h2.119a.186.186 0 0 0 .185-.186V.56a.185.185 0 0 0-.185-.186h-2.119a.186.186 0 0 0-.185.186v1.89c0 .103.083.186.185.186Zm2.955 5.44h2.118a.185.185 0 0 0 .186-.186V6a.185.185 0 0 0-.186-.186h-2.118a.185.185 0 0 0-.185.186v1.89c0 .103.083.186.185.186Z"&gt;&lt;/path&gt;
		&lt;/svg&gt;
		&lt;/div&gt;
		&lt;div class="search-container"&gt;
		&lt;input type="text" id="search-input" placeholder="Search Docker Hub"&gt;
		&lt;button id="search-button"&gt;
			&lt;svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"&gt;
			&lt;path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;/path&gt;
			&lt;/svg&gt;
		&lt;/button&gt;
		&lt;/div&gt;
		&lt;script&gt;
		function performSearch() {
			const query = document.getElementById('search-input').value;
			if (query) {
			window.location.href = '/search?q=' + encodeURIComponent(query);
			}
		}

		document.getElementById('search-button').addEventListener('click', performSearch);
		document.getElementById('search-input').addEventListener('keypress', function(event) {
			if (event.key === 'Enter') {
			performSearch();
			}
		});
		&lt;/script&gt;
	&lt;/body&gt;
	&lt;/html&gt;
	`</span><span class="p">;</span>
	<span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
	<span class="k">async</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="nx">getReqHeader</span> <span class="o">=</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> <span class="c1">// 获取请求头</span>

		<span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span> <span class="c1">// 解析请求URL</span>
		<span class="kd">const</span> <span class="nx">userAgentHeader</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">User-Agent</span><span class="dl">'</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">userAgent</span> <span class="o">=</span> <span class="nx">userAgentHeader</span> <span class="p">?</span> <span class="nx">userAgentHeader</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">null</span><span class="dl">"</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">UA</span><span class="p">)</span> <span class="nx">屏蔽爬虫UA</span> <span class="o">=</span> <span class="nx">屏蔽爬虫UA</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">await</span> <span class="nx">ADD</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">UA</span><span class="p">));</span>
		<span class="nx">workers_url</span> <span class="o">=</span> <span class="s2">`https://</span><span class="p">${</span><span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">pathname</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

		<span class="c1">// 获取请求参数中的 ns</span>
		<span class="kd">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">ns</span><span class="dl">'</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">hubhost</span><span class="dl">'</span><span class="p">)</span> <span class="o">||</span> <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">hostTop</span> <span class="o">=</span> <span class="nx">hostname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// 获取主机名的第一部分</span>

		<span class="kd">let</span> <span class="nx">checkHost</span><span class="p">;</span> <span class="c1">// 在这里定义 checkHost 变量</span>
		<span class="c1">// 如果存在 ns 参数，优先使用它来确定 hub_host</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">ns</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">ns</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">docker.io</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">hub_host</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">registry-1.docker.io</span><span class="dl">'</span><span class="p">;</span> <span class="c1">// 设置上游地址为 registry-1.docker.io</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">hub_host</span> <span class="o">=</span> <span class="nx">ns</span><span class="p">;</span> <span class="c1">// 直接使用 ns 作为 hub_host</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">checkHost</span> <span class="o">=</span> <span class="nx">routeByHosts</span><span class="p">(</span><span class="nx">hostTop</span><span class="p">);</span>
			<span class="nx">hub_host</span> <span class="o">=</span> <span class="nx">checkHost</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// 获取上游地址</span>
		<span class="p">}</span>

		<span class="kd">const</span> <span class="nx">fakePage</span> <span class="o">=</span> <span class="nx">checkHost</span> <span class="p">?</span> <span class="nx">checkHost</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// 确保 fakePage 不为 undefined</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`域名头部: </span><span class="p">${</span><span class="nx">hostTop</span><span class="p">}</span><span class="s2">\n反代地址: </span><span class="p">${</span><span class="nx">hub_host</span><span class="p">}</span><span class="s2">\n伪装首页: </span><span class="p">${</span><span class="nx">fakePage</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">isUuid</span> <span class="o">=</span> <span class="nx">isUUID</span><span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="nx">屏蔽爬虫UA</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">fxxk</span> <span class="o">=&gt;</span> <span class="nx">userAgent</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">fxxk</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nx">屏蔽爬虫UA</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// 首页改成一个nginx伪装页</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="k">await</span> <span class="nx">nginx</span><span class="p">(),</span> <span class="p">{</span>
				<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
					<span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/html; charset=UTF-8</span><span class="dl">'</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">});</span>
		<span class="p">}</span>

		<span class="kd">const</span> <span class="nx">conditions</span> <span class="o">=</span> <span class="p">[</span>
			<span class="nx">isUuid</span><span class="p">,</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/_</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/r/</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v2/repositories</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v2/user</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v2/orgs</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v2/_catalog</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v2/categories</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v2/feature-flags</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">search</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">source</span><span class="dl">'</span><span class="p">),</span>
			<span class="nx">pathname</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
			<span class="nx">pathname</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">/favicon.ico</span><span class="dl">'</span><span class="p">,</span>
			<span class="nx">pathname</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">/auth/profile</span><span class="dl">'</span><span class="p">,</span>
		<span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="nx">conditions</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">condition</span> <span class="o">=&gt;</span> <span class="nx">condition</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">fakePage</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">hostTop</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">docker</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">URL302</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">Response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">URL302</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">nginx</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
					<span class="c1">//首页改成一个nginx伪装页</span>
					<span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="k">await</span> <span class="nx">nginx</span><span class="p">(),</span> <span class="p">{</span>
						<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
							<span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/html; charset=UTF-8</span><span class="dl">'</span><span class="p">,</span>
						<span class="p">},</span>
					<span class="p">});</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">request</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">){</span>
				<span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="k">await</span> <span class="nx">searchInterface</span><span class="p">(),</span> <span class="p">{</span>
					<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
					  <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/html; charset=UTF-8</span><span class="dl">'</span><span class="p">,</span>
					<span class="p">},</span>
				<span class="p">});</span>
			<span class="p">}</span>

			<span class="kd">const</span> <span class="nx">newUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://registry.hub.docker.com</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">pathname</span> <span class="o">+</span> <span class="nx">url</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>

			<span class="c1">// 复制原始请求的标头</span>
			<span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>

			<span class="c1">// 确保 Host 头部被替换为 hub.docker.com</span>
			<span class="nx">headers</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Host</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">registry.hub.docker.com</span><span class="dl">'</span><span class="p">);</span>

			<span class="kd">const</span> <span class="nx">newRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">newUrl</span><span class="p">,</span> <span class="p">{</span>
					<span class="na">method</span><span class="p">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
					<span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span><span class="p">,</span>
					<span class="na">body</span><span class="p">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">HEAD</span><span class="dl">'</span> <span class="p">?</span> <span class="k">await</span> <span class="nx">request</span><span class="p">.</span><span class="nx">blob</span><span class="p">()</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
					<span class="na">redirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">follow</span><span class="dl">'</span>
			<span class="p">});</span>

			<span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">newRequest</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">// 修改包含 %2F 和 %3A 的请求</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/%2F/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">search</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="sr">/%3A/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">toString</span><span class="p">()))</span> <span class="p">{</span>
			<span class="kd">let</span> <span class="nx">modifiedUrl</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%3A</span><span class="se">(?=</span><span class="sr">.*</span><span class="se">?</span><span class="sr">&amp;</span><span class="se">)</span><span class="sr">/</span><span class="p">,</span> <span class="dl">'</span><span class="s1">%3Alibrary%2F</span><span class="dl">'</span><span class="p">);</span>
			<span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">modifiedUrl</span><span class="p">);</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`handle_url: </span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">// 处理token请求</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/token</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
			<span class="kd">let</span> <span class="nx">token_parameter</span> <span class="o">=</span> <span class="p">{</span>
				<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
					<span class="dl">'</span><span class="s1">Host</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">auth.docker.io</span><span class="dl">'</span><span class="p">,</span>
					<span class="dl">'</span><span class="s1">User-Agent</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">User-Agent</span><span class="dl">"</span><span class="p">),</span>
					<span class="dl">'</span><span class="s1">Accept</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Accept</span><span class="dl">"</span><span class="p">),</span>
					<span class="dl">'</span><span class="s1">Accept-Language</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Accept-Language</span><span class="dl">"</span><span class="p">),</span>
					<span class="dl">'</span><span class="s1">Accept-Encoding</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Accept-Encoding</span><span class="dl">"</span><span class="p">),</span>
					<span class="dl">'</span><span class="s1">Connection</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">keep-alive</span><span class="dl">'</span><span class="p">,</span>
					<span class="dl">'</span><span class="s1">Cache-Control</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">max-age=0</span><span class="dl">'</span>
				<span class="p">}</span>
			<span class="p">};</span>
			<span class="kd">let</span> <span class="nx">token_url</span> <span class="o">=</span> <span class="nx">auth_url</span> <span class="o">+</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="nx">url</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">token_url</span><span class="p">,</span> <span class="nx">request</span><span class="p">),</span> <span class="nx">token_parameter</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">// 修改 /v2/ 请求路径</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nx">hub_host</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">registry-1.docker.io</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="sr">/^</span><span class="se">\/</span><span class="sr">v2</span><span class="se">\/[^/]</span><span class="sr">+</span><span class="se">\/[^/]</span><span class="sr">+</span><span class="se">\/[^/]</span><span class="sr">+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sr">/^</span><span class="se">\/</span><span class="sr">v2</span><span class="se">\/</span><span class="sr">library/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">))</span> <span class="p">{</span>
			<span class="c1">//url.pathname = url.pathname.replace(/\/v2\//, '/v2/library/');</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">/v2/library/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v2/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`modified_url: </span><span class="p">${</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">// 更改请求的主机名</span>
		<span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">hub_host</span><span class="p">;</span>

		<span class="c1">// 构造请求参数</span>
		<span class="kd">let</span> <span class="nx">parameter</span> <span class="o">=</span> <span class="p">{</span>
			<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
				<span class="dl">'</span><span class="s1">Host</span><span class="dl">'</span><span class="p">:</span> <span class="nx">hub_host</span><span class="p">,</span>
				<span class="dl">'</span><span class="s1">User-Agent</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">User-Agent</span><span class="dl">"</span><span class="p">),</span>
				<span class="dl">'</span><span class="s1">Accept</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Accept</span><span class="dl">"</span><span class="p">),</span>
				<span class="dl">'</span><span class="s1">Accept-Language</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Accept-Language</span><span class="dl">"</span><span class="p">),</span>
				<span class="dl">'</span><span class="s1">Accept-Encoding</span><span class="dl">'</span><span class="p">:</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Accept-Encoding</span><span class="dl">"</span><span class="p">),</span>
				<span class="dl">'</span><span class="s1">Connection</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">keep-alive</span><span class="dl">'</span><span class="p">,</span>
				<span class="dl">'</span><span class="s1">Cache-Control</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">max-age=0</span><span class="dl">'</span>
			<span class="p">},</span>
			<span class="na">cacheTtl</span><span class="p">:</span> <span class="mi">3600</span> <span class="c1">// 缓存时间</span>
		<span class="p">};</span>

		<span class="c1">// 添加Authorization头</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
			<span class="nx">parameter</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">Authorization</span> <span class="o">=</span> <span class="nx">getReqHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">// 发起请求并处理响应</span>
		<span class="kd">let</span> <span class="nx">original_response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">request</span><span class="p">),</span> <span class="nx">parameter</span><span class="p">);</span>
		<span class="kd">let</span> <span class="nx">original_response_clone</span> <span class="o">=</span> <span class="nx">original_response</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
		<span class="kd">let</span> <span class="nx">original_text</span> <span class="o">=</span> <span class="nx">original_response_clone</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
		<span class="kd">let</span> <span class="nx">response_headers</span> <span class="o">=</span> <span class="nx">original_response</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
		<span class="kd">let</span> <span class="nx">new_response_headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">(</span><span class="nx">response_headers</span><span class="p">);</span>
		<span class="kd">let</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">original_response</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>

		<span class="c1">// 修改 Www-Authenticate 头</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">new_response_headers</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">Www-Authenticate</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
			<span class="kd">let</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">new_response_headers</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">Www-Authenticate</span><span class="dl">"</span><span class="p">);</span>
			<span class="kd">let</span> <span class="nx">re</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">auth_url</span><span class="p">,</span> <span class="dl">'</span><span class="s1">g</span><span class="dl">'</span><span class="p">);</span>
			<span class="nx">new_response_headers</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Www-Authenticate</span><span class="dl">"</span><span class="p">,</span> <span class="nx">response_headers</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">Www-Authenticate</span><span class="dl">"</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="nx">workers_url</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="c1">// 处理重定向</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">new_response_headers</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">httpHandler</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">new_response_headers</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location</span><span class="dl">"</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="c1">// 返回修改后的响应</span>
		<span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">original_text</span><span class="p">,</span> <span class="p">{</span>
			<span class="nx">status</span><span class="p">,</span>
			<span class="na">headers</span><span class="p">:</span> <span class="nx">new_response_headers</span>
		<span class="p">});</span>
		<span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**
 * 处理HTTP请求
 * @param {Request} req 请求对象
 * @param {string} pathname 请求路径
 */</span>
<span class="kd">function</span> <span class="nx">httpHandler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">pathname</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">reqHdrRaw</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>

	<span class="c1">// 处理预检请求</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">OPTIONS</span><span class="dl">'</span> <span class="o">&amp;&amp;</span>
		<span class="nx">reqHdrRaw</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="dl">'</span><span class="s1">access-control-request-headers</span><span class="dl">'</span><span class="p">)</span>
	<span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">PREFLIGHT_INIT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kd">let</span> <span class="nx">rawLen</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>

	<span class="kd">const</span> <span class="nx">reqHdrNew</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">(</span><span class="nx">reqHdrRaw</span><span class="p">);</span>

	<span class="kd">const</span> <span class="nx">refer</span> <span class="o">=</span> <span class="nx">reqHdrNew</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">referer</span><span class="dl">'</span><span class="p">);</span>

	<span class="kd">let</span> <span class="nx">urlStr</span> <span class="o">=</span> <span class="nx">pathname</span><span class="p">;</span>

	<span class="kd">const</span> <span class="nx">urlObj</span> <span class="o">=</span> <span class="nx">newUrl</span><span class="p">(</span><span class="nx">urlStr</span><span class="p">);</span>

	<span class="cm">/** @type {RequestInit} */</span>
	<span class="kd">const</span> <span class="nx">reqInit</span> <span class="o">=</span> <span class="p">{</span>
		<span class="na">method</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
		<span class="na">headers</span><span class="p">:</span> <span class="nx">reqHdrNew</span><span class="p">,</span>
		<span class="na">redirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">follow</span><span class="dl">'</span><span class="p">,</span>
		<span class="na">body</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="nx">proxy</span><span class="p">(</span><span class="nx">urlObj</span><span class="p">,</span> <span class="nx">reqInit</span><span class="p">,</span> <span class="nx">rawLen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**
 * 代理请求
 * @param {URL} urlObj URL对象
 * @param {RequestInit} reqInit 请求初始化对象
 * @param {string} rawLen 原始长度
 */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">proxy</span><span class="p">(</span><span class="nx">urlObj</span><span class="p">,</span> <span class="nx">reqInit</span><span class="p">,</span> <span class="nx">rawLen</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">urlObj</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="nx">reqInit</span><span class="p">);</span>
	<span class="kd">const</span> <span class="nx">resHdrOld</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
	<span class="kd">const</span> <span class="nx">resHdrNew</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">(</span><span class="nx">resHdrOld</span><span class="p">);</span>

	<span class="c1">// 验证长度</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">rawLen</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="nx">newLen</span> <span class="o">=</span> <span class="nx">resHdrOld</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">content-length</span><span class="dl">'</span><span class="p">)</span> <span class="o">||</span> <span class="dl">''</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">badLen</span> <span class="o">=</span> <span class="p">(</span><span class="nx">rawLen</span> <span class="o">!==</span> <span class="nx">newLen</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="nx">badLen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">makeRes</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="p">{</span>
				<span class="dl">'</span><span class="s1">--error</span><span class="dl">'</span><span class="p">:</span> <span class="s2">`bad len: </span><span class="p">${</span><span class="nx">newLen</span><span class="p">}</span><span class="s2">, except: </span><span class="p">${</span><span class="nx">rawLen</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
				<span class="dl">'</span><span class="s1">access-control-expose-headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">--error</span><span class="dl">'</span><span class="p">,</span>
			<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="kd">const</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
	<span class="nx">resHdrNew</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">access-control-expose-headers</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">resHdrNew</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">access-control-allow-origin</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">resHdrNew</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Cache-Control</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">max-age=1500</span><span class="dl">'</span><span class="p">);</span>

	<span class="c1">// 删除不必要的头</span>
	<span class="nx">resHdrNew</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">content-security-policy</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">resHdrNew</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">content-security-policy-report-only</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">resHdrNew</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">clear-site-data</span><span class="dl">'</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="p">{</span>
		<span class="nx">status</span><span class="p">,</span>
		<span class="na">headers</span><span class="p">:</span> <span class="nx">resHdrNew</span>
	<span class="p">});</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">ADD</span><span class="p">(</span><span class="nx">envadd</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">addtext</span> <span class="o">=</span> <span class="nx">envadd</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">	 |"'</span><span class="se">\r\n]</span><span class="sr">+/g</span><span class="p">,</span> <span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/,+/g</span><span class="p">,</span> <span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">);</span>	<span class="c1">// 将空格、双引号、单引号和换行符替换为逗号</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">addtext</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">)</span> <span class="nx">addtext</span> <span class="o">=</span> <span class="nx">addtext</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">addtext</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">addtext</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">)</span> <span class="nx">addtext</span> <span class="o">=</span> <span class="nx">addtext</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">addtext</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kd">const</span> <span class="nx">add</span> <span class="o">=</span> <span class="nx">addtext</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">);</span>
	<span class="k">return</span> <span class="nx">add</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li><p>再次点击部署，如果你没有自己的域名就可以结束了，把上一步2处的域名作为上一篇博文中的一个代理使用了</p><li><p>把注册的域名绑定到脚本 <img data-proofer-ignore data-src="../static/posts/2024/2024-11-16-添加自己得docker加速镜像05.png" alt="编辑代码" /></p></ol><h2 id="域名注册">域名注册<a href="#域名注册"><i class="fas fa-hashtag"></i></a></h2></h2><p>注册地址：<a href="https://register.us.kg">https://register.us.kg</a></p><hr /><p><strong>参考资料</strong></p><ul><li><a href="https://blog.enianteam.com/u/sun/content/265">snap 安装的docker，如何添加加速镜像和重启服务</a><li><a href="https://xuanyuan.me/blog/archives/1154?from=tencent#_registry_mirror">Docker/DockerHub 国内镜像源/加速列表（10月21日更新-长期维护）</a></ul><p> 本文会经常更新，请阅读原文： <a href="/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F">https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F</a> ，以避免陈旧错误知识的误导，同时有更好的阅读体验。</p><p> <a rel="知识共享许可协议" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="知识共享许可协议" src="https://dashenxian.github.io/assets/img/by-nc-sa.svg" /> </a></p><p> 本作品采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名 小神仙 （包含链接： <a href="https://dashenxian.github.io">https://dashenxian.github.io</a> ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请 <a href="mailto:125880321@qq.com">与我联系 (125880321@qq.com)</a> 。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/docker/'>docker</a>, <a href='/categories/ubantu/'>ubantu</a>, <a href='/categories/snap/'>snap</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="comments-wrapper"> 登录 GitHub 账号进行评论</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=添加自己得docker加速镜像 - dashenxian&url=https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=添加自己得docker加速镜像 - dashenxian&u=https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=添加自己得docker加速镜像 - dashenxian&url=https://dashenxian.github.io/post/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E5%BE%97docker%E5%8A%A0%E9%80%9F%E9%95%9C%E5%83%8F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/post/IDisposable%E9%87%8A%E6%94%BE%E8%B5%84%E6%BA%90%E6%A8%A1%E6%9D%BF">IDisposable释放资源模板</a><li><a href="/post/vultr+v2ray%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91">vultr+v2ray科学上网</a><li><a href="/post/GitHub%E4%BB%A3%E4%B8%8B%E8%BD%BD-%E6%96%87%E4%BB%B6%E5%8A%A0%E9%80%9F-%E7%BD%91%E7%AB%99%E5%88%97%E8%A1%A8-%E8%BD%AC%E8%BD%BD">GitHub代下载（文件加速）网站列表（转载）</a><li><a href="/post/21.%E5%90%88%E5%B9%B6%E4%B8%A4%E4%B8%AA%E6%9C%89%E5%BA%8F%E9%93%BE%E8%A1%A8">21.合并两个有序链表</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><section class="comments"> <script src="https://utteranc.es/client.js" repo="dashenxian/BlogComments" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></section></div></div></div><footer class="d-flex flex-column w-100 justify-content-center"><div id="analytics-box"> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', ''); }); </script> <script async type="text/javascript">document.write(unescape("%3Cspan id=''%3E%3C/span%3E%3Cscript src='//s22.cnzz.com/z_stat.php%3Fid%3D1264408226%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2014-2024 <a href="https://github.com/dashenxian">dashenxian</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由小神仙按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，基于 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题修改。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
